name: Process Videos

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  VIDEO_DATA: './data/videos'

jobs:
  process-videos:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup Node.js environment
      uses: actions/setup-node@v2.4.0
      with:
        node-version: '19.8.1'

    - name: Setup yt-dlp
      uses: AnimMouse/setup-yt-dlp@v1

    - name: Download Playlists and Subtitles
      run: |

        declare -A playlists=(
            ["2023"]="https://www.youtube.com/playlist?list=PLm8zJ0HKEJIZ6OtS-D6PUpn4TflgVqi7R"
            ["2022"]="https://www.youtube.com/playlist?list=PLm8zJ0HKEJIYq6FBpOBHfHchjI0zTYINO"
            ["2021"]="https://www.youtube.com/playlist?list=PLm8zJ0HKEJIbQgPDRsUHiawVtahvShN8X"
            ["2020"]="https://www.youtube.com/playlist?list=PLm8zJ0HKEJIaarwTpOzGg4DXXVLWy2GVU"
            ["2019"]="https://www.youtube.com/playlist?list=PLm8zJ0HKEJIZXGbpAdjpIP9cuuJYfOW-F"
            ["2018"]="https://www.youtube.com/playlist?list=PLm8zJ0HKEJIaNfzV_-f0aYvrpAZAzjhIl"
            ["2017"]="https://www.youtube.com/playlist?list=PLm8zJ0HKEJIYAk9rAz1CQmE9Pzn8G_hrq"
            ["2016"]="https://www.youtube.com/playlist?list=PLm8zJ0HKEJIZtQ0PqjW341QIWrqPPkQXi"
            ["2015"]="https://www.youtube.com/playlist?list=PLm8zJ0HKEJIZz_vKS1amJguyAEIiTtxjw"            
        )
        
        for year in "${!playlists[@]}"; do
          echo "Processing playlists $year"
          {
            yt-dlp --ignore-errors --write-info-json --skip-download -o "$VIDEO_DATA/$year/%(title)s [%(id)s].%(ext)s" ${playlists[$year]}
          } || {
            echo "Error occurred, but continuing"
          }
        done

    - name: Delete Playlists Metadata
      run: |

        find . -type f -name "*\[PL*\]*"  -exec rm {} \;

    - name: Download Subtitles (VTTs) for all Videos
      run: |

        IFS=$'\n' # set the Internal Field Separator to newline, ignore the spaces
        for f in $(find $VIDEO_DATA -type f -name '*.json'); do # TODO remove 2023
          ytid=$(jq -r .id $f)
          echo $ytid
          dname=$(dirname $f)
          bname=$(basename $f)
          ff="${bname%.info.json}"
          yt-dlp --sub-lan=en --write-auto-sub --skip-download -o "$dname/$ff" $ytid
        done

    - name: Generate Wordcount from Subs
      run: |

        node ./bin/wordcount.js $VIDEO_DATA ./data/wordcount.txt
        node ./bin/wordcount.js $VIDEO_DATA ./data/wordcount_video_stats.txt --include-video-stats

    - name: Generate Topic Lists for Filter search
      run: 
  
        ./bin/gen-all-topics.sh
    
    - name: Generate Wordcount
      run: |
    
        node ./bin/compile-db.js ./data/videos ./data/db.json

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git checkout -b build-dist
        git add ./data
        git commit -m "Update data files"
        git push origin build-dist --force
